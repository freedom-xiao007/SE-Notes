# Java业务开发常见错误100例
***
## 多线程类
- threadlocal：用资源独占解决线程安全；但需要注意线程池使用时的复用问题，需及时清理退出数据
- ConcurrentHashmap：注意复合逻辑锁的问题；需要充分了解其特性
- CopyOnWriteArrayList：注意使用场景
- 函数中调函数，可能需要两个函数同时加锁
- 注意锁和被保护对象是否是一个层次的：静态型的需要类层次锁；非静态用实力即可
- 考虑锁的范围，尽量细粒度；或区分场景以及资源的访问冲突，考虑使用悲观还是乐观方式的锁
- 多锁访问小心死锁，可以使用jstack查看分析，避免死锁：可以用超时设置；确定锁的获取顺序
- 线程池需要手动进行：计算密集型CPU数+1；I/O型看实际情况
    - 不会初始化 corePoolSize 个线程，有任务来了才创建工作线程；（要点）
    - 当核心线程满了之后不会立即扩容线程池，而是把任务堆积到工作队列中；
    - 当工作队列满了后扩容线程池，一直到线程个数达到 maximumPoolSize 为止；（要点）
    - 如果队列已满且达到了最大线程后还有任务进来，按照拒绝策略处理；
    - 当线程数大于核心线程数时，线程等待 keepAliveTime 后还是没有任务需要处理的话，收缩线程到核心线程数。